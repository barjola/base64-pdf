<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Base64 to PDF Viewer</title>
  <style>
    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      height: 100%;
      font-family: sans-serif;
      overflow: hidden;
    }

    .container {
      display: flex;
      height: 100%;
      width: 100%;
    }

    .sidebar {
      min-width: 150px;
      background: #f0f0f0;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      width: 30%;
    }

    .resizer {
      width: 5px;
      background: #ccc;
      cursor: col-resize;
      position: relative;
      z-index: 1;
    }

    .viewer {
      flex: 1;
      height: 100%;
      border: none;
    }

    textarea {
      flex: 1;
      width: 100%;
      resize: none;
      font-family: monospace;
      font-size: 0.9rem;
      padding: 0.5rem;
    }

    input[type="text"] {
      margin-top: 0.5rem;
      padding: 0.4rem;
      font-size: 0.9rem;
      width: 100%;
    }

    button {
      margin-top: 0.5rem;
      padding: 0.5rem;
      font-size: 0.9rem;
      cursor: pointer;
    }

    h2 {
      margin-top: 0;
    }

    .error {
      color: red;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="sidebar" id="leftPane">
    <h2>Base64 / JSON</h2>
    <div id="error" class="error"></div>
    <textarea id="base64input" placeholder="Paste here the Base64 or JSON with base64File attribute"></textarea>

    <input type="text" id="filename" value="download.pdf" placeholder="File name" />

    <button id="downloadBtn">⬇ Download PDF</button>
  </div>

  <div class="resizer" id="resizer"></div>

  <iframe id="pdfviewer" class="viewer"></iframe>
</div>

<script>
  const textarea = document.getElementById("base64input");
  const iframe = document.getElementById("pdfviewer");
  const errorDiv = document.getElementById("error");
  const resizer = document.getElementById("resizer");
  const leftPane = document.getElementById("leftPane");
  const filenameInput = document.getElementById("filename");
  const downloadBtn = document.getElementById("downloadBtn");

  let currentBlob = null;

  const savedWidth = localStorage.getItem("leftPaneWidth");
  if (savedWidth) {
    leftPane.style.width = savedWidth + "px";
  }

  function buscarBase64File(obj) {
    if (typeof obj !== "object" || obj === null) return null;
    if (Array.isArray(obj)) {
      for (const item of obj) {
        const result = buscarBase64File(item);
        if (result) return result;
      }
    } else {
      for (const key in obj) {
        if (key === "base64File" && typeof obj[key] === "string") {
          return obj[key];
        }
        const result = buscarBase64File(obj[key]);
        if (result) return result;
      }
    }
    return null;
  }

  function actualizarPDF() {
    const input = textarea.value.trim();
    let base64 = input;

    try {
      const json = JSON.parse(input);
      const encontrado = buscarBase64File(json);
      if (encontrado) base64 = encontrado;
    } catch (e) {}

    if (base64.startsWith("data:application/pdf;base64,")) {
      base64 = base64.split(",")[1];
    }

    try {
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }

      const blob = new Blob([bytes], { type: "application/pdf" });
      currentBlob = blob;

      const url = URL.createObjectURL(blob);
      iframe.src = url;
      errorDiv.textContent = "";
    } catch (err) {
      iframe.src = "";
      currentBlob = null;
      errorDiv.textContent = "⚠️ Invalid Base64 data or JSON format.";
    }
  }

  textarea.addEventListener("input", () => {
    if (textarea.value.trim().length > 0) {
      actualizarPDF();
    } else {
      iframe.src = "";
      currentBlob = null;
      errorDiv.textContent = "";
    }
  });

  downloadBtn.addEventListener("click", () => {
    if (!currentBlob) {
      alert("Invalid PDF data. Please check the Base64 input.");
      return;
    }

    const filename = filenameInput.value.trim() || "download.pdf";
    const link = document.createElement("a");
    link.href = URL.createObjectURL(currentBlob);
    link.download = filename;
    link.click();
  });

  let isResizing = false;

  resizer.addEventListener("mousedown", function (e) {
    isResizing = true;
    document.body.style.cursor = "col-resize";
  });

  document.addEventListener("mousemove", function (e) {
    if (!isResizing) return;
    const newWidth = Math.max(150, e.clientX);
    leftPane.style.width = newWidth + "px";
    localStorage.setItem("leftPaneWidth", newWidth);
  });

  document.addEventListener("mouseup", function () {
    if (isResizing) {
      isResizing = false;
      document.body.style.cursor = "default";
    }
  });

  textarea.addEventListener("click", function () {
    textarea.select();
  });

</script>

</body>
</html>
